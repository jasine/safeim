using System;
using System.Collections.Generic;
using System.Text;
using System.Windows.Forms;
using System.Drawing;
using System.Drawing.Drawing2D;
using System.ComponentModel;
using System.Xml;

namespace Client
{
	/// <summary>
	/// Description of QQListBox.
	/// </summary>
	public partial class QQListBox : ListBox
	{
		public QQListBoxItem mouseitem;
        public string _xmlpath="QQdate.xml";
		private QQListBoxItemCollection _items;
		
		public QQListBox()
            : base()
        {		
            _items = new QQListBoxItemCollection(this);
            base.DrawMode = DrawMode.OwnerDrawVariable;            
            InitializeComponent();
            this.SetStyle(ControlStyles.UserPaint, true);
            this.SetStyle(ControlStyles.DoubleBuffer, true);// Ë«»º³å
            this.SetStyle(ControlStyles.ResizeRedraw, true);//µ÷Õû´óÐ¡Ê±ÖØ»æ
            this.SetStyle(ControlStyles.AllPaintingInWmPaint, true); // ½ûÖ¹²Á³ý±³¾°.
            this.SetStyle(ControlStyles.OptimizedDoubleBuffer, true);// Ë«»º³å            
            this.SetStyle(ControlStyles.SupportsTransparentBackColor, true);
            //this.BackColor=Color.Transparent;
        }
        [Localizable(true)]
        [MergableProperty(false)]
        [DesignerSerializationVisibility(
            DesignerSerializationVisibility.Content)]

       public string Xmlpath
        {
            get { return _xmlpath; }
            set {_xmlpath=value; }
        }
     
       public new QQListBoxItemCollection Items
        {
            get { return _items; }
        }
      
       internal ListBox.ObjectCollection OldItems
        {
            get { return base.Items; }
        }
       
       protected override void OnPaint(PaintEventArgs e)
        {
         	//Bitmap bg=new Bitmap(this.ClientRectangle.Width,this.ClientRectangle.Height);         	
         	//Graphics g =Graphics.FromImage(bg);
         	Graphics g=e.Graphics;
         	#region »æÖÆÑ¡ÖÐÏî
       	    //ÅÐ¶ÏÊÇ·ñÓÐÑ¡ÖÐÏî
            if (this.Focused && this.SelectedItem != null)
            {
            	//µÃµ½Ñ¡ÖÐÏîµÄÇøÓò
            	Rectangle bounds = this.GetItemRectangle(this.SelectedIndex);
            	//ÅÐ¶ÏÑ¡ÖÐÏîÊÇ·ñÎª·ÖÀà
            	if (Items[this.SelectedIndex].IsClass)
            	{
            	     //g.FillRectangle(new SolidBrush(Color.FromArgb(230,238,241)),bounds);
                     //Items[this.SelectedIndex].DrawImage(global::QQListBox.Properties.Resources.MainPanel_FolderNode_collapseTexture, new Rectangle(bounds.X+3,bounds.Y+6,12,12));
                     g.DrawString(Items[this.SelectedIndex].Title, new Font("Î¢ÈíÑÅºÚ", 9), new SolidBrush(Color.Black), bounds.Left + 15, bounds.Top + 4);
            	}
            	else
            	{
            		g.FillRectangle(new SolidBrush(Color.FromArgb(252,233,161)),bounds);
            	}

            }
            #endregion
            
            //Ñ­»·»æÖÆÃ¿Ïî
            for (int i = 0; i < Items.Count; i++)
            {
               Rectangle bounds = this.GetItemRectangle(i) ;
               QQListBoxItem item = Items[i];               
              if (item.IsClass==true)
		      {                  
                //g.FillRectangle(new SolidBrush(Color.FromArgb(50,230,238,241)),bounds);
                //g.DrawImage(global::QQListBox.Properties.Resources.MainPanel_FolderNode_collapseTexture, new Rectangle(bounds.X+3,bounds.Y+6,12,12));
                if(mouseitem==Items[i] && mouseitem!=this.SelectedItem)
                { 
                	g.FillRectangle(new SolidBrush(Color.FromArgb(50,230,238,241)),bounds);                
                }
                 g.DrawString(item.Title, new Font("Î¢ÈíÑÅºÚ", 9), new SolidBrush(Color.Black), bounds.Left + 15, bounds.Top + 4);
              }
              else
              {
  
                if ( item!=this.SelectedItem)
                {

                	Color backColor = Color.FromArgb(20,216,211,211);
                    using (SolidBrush brush = new SolidBrush(backColor))
                    {
                    	//g.FillRectangle(new SolidBrush(Color.White),bounds);
                    	g.FillRectangle(brush, new Rectangle(bounds.X+1,bounds.Y+1,bounds.Width-2,bounds.Height-1));
                    }
                }
                if(mouseitem==Items[i] && mouseitem!=this.SelectedItem)
                {
                    Color backColor = Color.FromArgb(200,192,224,248);
                    using (SolidBrush brush = new SolidBrush(backColor))
                    {
                    	//g.FillRectangle(new SolidBrush(Color.White),bounds);
                    	g.FillRectangle(brush, new Rectangle(bounds.X+1,bounds.Y+1,bounds.Width-2,bounds.Height-1));
                    }
                
                }
                Image image = item.Image;
                string text = item.ToString();
              
                if (image != null)
                {
                    g.InterpolationMode =  InterpolationMode.HighQualityBilinear;
                    g.DrawImage(image,new Rectangle(bounds.X+12,bounds.Y+7,image.Size.Width,image.Size.Height));
                }
                int tw=40;
                if(item.Remarks!=null)
                {
                g.DrawString(item.Remarks,new Font("Î¢ÈíÑÅºÚ", 9), new SolidBrush(this.ForeColor), bounds.Left + tw + 15, bounds.Top + 4);                
                tw=item.Remarks.Length+tw+25;
               // item.Remarks.
                }
               // GetTextSize()
                //g.DrawString("(" + item.Title + ")", /*this.Font*/new Font("Î¢ÈíÑÅºÚ", 9), new SolidBrush(Color.FromArgb(128, 128, 128)), bounds.Left + tw + 15, bounds.Top + 4);
                g.DrawString(item.Text, new Font("Î¢ÈíÑÅºÚ", 9), new SolidBrush(Color.FromArgb(128, 128, 128)), bounds.Left + 40 + 15, bounds.Top + 19);

              }
            }
            base.OnPaint(e);
         //   e.Graphics.DrawImage(bg,this.ClientRectangle);
        }


      #region//»æÖÆÏî
//      protected override void OnDrawItem(DrawItemEventArgs e)
//        {
//            base.OnDrawItem(e);
//            if (e.Index != -1 && base.Items.Count > 0)
//            {
//                System.Diagnostics.Debug.WriteLine(e.State);
//                Rectangle bounds = e.Bounds;
//                QQListBoxItem item = Items[e.Index];
//                Graphics g = e.Graphics;
//              if (item.IsClass==true)
//		      {                  
//              	g.FillRectangle(new SolidBrush(Color.FromArgb(50,230,238,241)),bounds);
//               // g.DrawImage(global::QQListBox.Properties.Resources.MainPanel_FolderNode_collapseTexture, new Rectangle(bounds.X+3,bounds.Y+6,12,12));
//
//                g.DrawString(item.Title, new Font("Î¢ÈíÑÅºÚ", 9), new SolidBrush(Color.Black), bounds.Left + 15, bounds.Top + 4);
//              }
//              else
//              {
//  
//                if ((e.State & DrawItemState.Selected) == DrawItemState.Selected)
//                {
//                    //g.DrawString(item.Title,new Font("Î¢ÈíÑÅºÚ", 9), new SolidBrush(Color.Black), bounds.Left + 70 + 10, bounds.Top + 4);
//                	e.Graphics.FillRectangle(new SolidBrush(Color.FromArgb(252,233,161)),bounds);
//                }
//                else
//                {
//                	Color backColor = Color.FromArgb(60,216,211,211);
//                    using (SolidBrush brush = new SolidBrush(backColor))
//                    {
//                    	g.FillRectangle(new SolidBrush(Color.White),bounds);
//                    	g.FillRectangle(brush, new Rectangle(bounds.X+1,bounds.Y+1,bounds.Width-2,bounds.Height-1));
//                    }
//                }
//
//                Image image = item.Image;
//                string text = item.ToString();
//              
//                if (image != null)
//                {
//                    g.InterpolationMode =  InterpolationMode.HighQualityBilinear;
//                    g.DrawImage(image,new Rectangle(bounds.X+12,bounds.Y+7,image.Size.Width,image.Size.Height));
//                }
//               // int Tw=0;
//                if(item.Remarks!=null)
//                {
//                g.DrawString(item.Remarks,new Font("Î¢ÈíÑÅºÚ", 9), new SolidBrush(this.ForeColor), bounds.Left + 40 + 15, bounds.Top + 4);                
//               // tw=item.Remarks
//                }
//                g.DrawString("(" + item.Title + ")", /*this.Font*/new Font("Î¢ÈíÑÅºÚ", 9), new SolidBrush(Color.FromArgb(128, 128, 128)), bounds.Left + 70 + 15, bounds.Top + 4);
//                g.DrawString(item.Text, new Font("Î¢ÈíÑÅºÚ", 9), new SolidBrush(Color.FromArgb(128, 128, 128)), bounds.Left + 40 + 15, bounds.Top + 19);
//
//                if ((e.State & DrawItemState.Focus) ==
//                    DrawItemState.Focus)
//                {
//                    e.DrawFocusRectangle();
//                }
//              }
//            }
//        }
	  #endregion
      protected override void OnMeasureItem(MeasureItemEventArgs e)
	  {
		base.OnMeasureItem(e);        
        try
        {
            QQListBoxItem item = Items[e.Index];
            if (item.IsClass == true)
            { e.ItemHeight = 25; }
            else
            { e.ItemHeight = 54; }
        }
        catch { }
	  }
	  protected override void OnClick(EventArgs e)
	  {
		base.OnClick(e);
     	//this.Items.Clear(); 
     	//while ( this.SelectedItems.Count > 0 )
        //this.Items.Remove ( this.SelectedItems[0] );
	  }
	  protected override void OnSelectedIndexChanged(EventArgs e)
	  {
		base.OnSelectedIndexChanged(e);
		QQListBoxItem item = Items[this.SelectedIndex];
		//MessageBox.Show(this.SelectedIndex.ToString());
        if (item.IsClass == true && item.IsExpand == true)
        {
            for (int i = this._items.Count - 1; i >= 0; i--)
            {
                if (this._items[i].Classid == item.Classid && this._items[i] != item)
                {
                    this._items.RemoveAt(i);
                }
            }
            item.IsExpand = false;
        }
        else if (item.IsClass == true)
        {
            item.IsExpand = true;
            try
            {
                XmlDocument doc = new XmlDocument();
                doc.Load(_xmlpath);
                XmlNodeList Qd = doc.DocumentElement.ChildNodes[item.Classid].ChildNodes;
                int i = 1;
                foreach (XmlNode Qi in Qd)
                {
                    this._items.Insert(
                        this.SelectedIndex+i,
                        new QQListBoxItem(
                            item.Classid, 
                            int.Parse(Qi.Attributes["qq"].Value),
                            Qi.Attributes["title"].Value, 
                            Qi.Attributes["remarks"].Value,
                            Qi.Attributes["text"].Value, 
                            new Bitmap(Qi.Attributes["image"].Value),
                            true, 
                            true, 
                            true));
                    i++;
   
                }

            }
            catch (Exception A)
            {
                Console.WriteLine("Exception: {0}", A.ToString());
            }  
        
        }
        this.Invalidate();
 	  }
      protected override void OnDoubleClick(EventArgs e)
      {
          base.OnDoubleClick(e);
          QQListBoxItem item = Items[this.SelectedIndex];
         // MessageBox.Show(this.SelectedIndex.ToString());
      }
	  protected override void OnMouseMove(MouseEventArgs e)
	  {
		base.OnMouseMove(e);
		for(int i = 0; i < Items.Count; i++)
		{
			Rectangle bounds = this.GetItemRectangle(i) ;
			if(bounds.Contains(e.X,e.Y))
			{				
				if (Items[i]!=mouseitem)
				{
				  mouseitem=Items[i];
				 this.Invalidate();
				} 
			}
		}		
	  }
	  
	  #region ÍÏ¶¯
	  //private ListBox sourcelbl;
	  protected override void OnDragOver(DragEventArgs e)
	  {
		 base.OnDragOver(e);
		             //ÍÏ¶¯Ô´ºÍ·ÅÖÃµÄÄ¿µÄµØÒ»¶¨ÊÇÒ»¸öListBox
            if (e.Data.GetDataPresent(typeof(System.String)))
            {
                e.Effect = DragDropEffects.Move;
            }
            else
                e.Effect = DragDropEffects.None;


	  }
	  protected override void OnDragDrop(DragEventArgs drgevent)
	  {
		base.OnDragDrop(drgevent);
	  }
	  #endregion
	  //¼ÆËãÎÄ±¾³¤¶È
	  private int StringLength(string text)
      {
            int len = 0;

            for (int i = 0; i < text.Length; i++)
            {
                byte[] byte_len = System.Text.Encoding.Default.GetBytes(text.Substring(i, 1));
                if (byte_len.Length > 1)
                    len += 2;  //Èç¹û³¤¶È´óÓÚ1£¬ÊÇÖÐÎÄ£¬Õ¼Á½¸ö×Ö½Ú£¬+2
                else
                    len += 1;  //Èç¹û³¤¶ÈµÈÓÚ1£¬ÊÇÓ¢ÎÄ£¬Õ¼Ò»¸ö×Ö½Ú£¬+1
            }

            return len;
       }
	}
}

#region ListBoµÄÒ»Ð©ÓÃ·¨
//1. ÊôÐÔÁÐ±í£º

//    SelectionMode    ×é¼þÖÐÌõÄ¿µÄÑ¡ÔñÀàÐÍ£¬¼´¶àÑ¡(Multiple)¡¢µ¥Ñ¡(Single)
//    Rows             ÁÐ±í¿òÖÐÏÔÊ¾×Ü¹²¶àÉÙÐÐ
//    Selected         ¼ì²âÌõÄ¿ÊÇ·ñ±»Ñ¡ÖÐ
//    SelectedItem     ·µ»ØµÄÀàÐÍÊÇListItem£¬»ñµÃÁÐ±í¿òÖÐ±»Ñ¡ÔñµÄÌõÄ¿
//    Count            ÁÐ±í¿òÖÐÌõÄ¿µÄ×ÜÊý
//    SelectedIndex    ÁÐ±í¿òÖÐ±»Ñ¡ÔñÏîµÄË÷ÒýÖµ
//    Items            ·ºÖ¸ÁÐ±í¿òÖÐµÄËùÓÐÏî£¬Ã¿Ò»ÏîµÄÀàÐÍ¶¼ÊÇListItem

//2. È¡ÁÐ±í¿òÖÐ±»Ñ¡ÖÐµÄÖµ  

//     ListBox.SelectedValue  

//3. ¶¯Ì¬µÄÌí¼ÓÁÐ±í¿òÖÐµÄÏî£º

//     ListBox.Items.Add("ËùÒªÌí¼ÓµÄÏî");

//4. ÒÆ³öÖ¸¶¨Ïî£º

//     //Ê×ÏÈÅÐ¶ÏÁÐ±í¿òÖÐµÄÏîÊÇ·ñ´óÓÚ0
//     If(ListBox.Items.Count > 0 )
//     {
////ÒÆ³öÑ¡ÔñµÄÏî
//ListBox.Items.Remove(ListBox.SelectedItem);
//     }

//5. Çå¿ÕËùÓÐÏî£º

//     //Ê×ÏÈÅÐ¶ÏÁÐ±í¿òÖÐµÄÏîÊÇ·ñ´óÓÚ0
//     If(ListBox.Items.Count > 0 )
//     {
////Çå¿ÕËùÓÐÏî
//ListBox.Items.Clear();
//     }

//6. ÁÐ±í¿ò¿ÉÒÔÒ»´ÎÑ¡Ôñ¶àÏî£º
   
//     Ö»ÐèÉèÖÃÁÐ±í¿òµÄÊôÐÔ SelectionMode="Multiple",°´Ctrl¿ÉÒÔ¶àÑ¡

//7. Á½¸öÁÐ±í¿òÁª¶¯£¬¼´Á½¼¶Áª¶¯²Ëµ¥

//     //ÅÐ¶ÏµÚÒ»¸öÁÐ±í¿òÖÐ±»Ñ¡ÖÐµÄÖµ
//     switch(ListBox1.SelectValue)
//     {
////Èç¹ûÊÇ"A"£¬µÚ¶þ¸öÁÐ±í¿òÖÐ¾ÍÌí¼ÓÕâÐ©£º
//case "A"
//      ListBox2.Items.Clear();
//      ListBox2.Items.Add("A1");
//      ListBox2.Items.Add("A2");
//      ListBox2.Items.Add("A3");
////Èç¹ûÊÇ"B"£¬µÚ¶þ¸öÁÐ±í¿òÖÐ¾ÍÌí¼ÓÕâÐ©£º
//case "B"
//      ListBox2.Items.Clear();
//      ListBox2.Items.Add("B1");
//      ListBox2.Items.Add("B2");
//      ListBox2.Items.Add("B3");
//     }

//8. ÊµÏÖÁÐ±í¿òÖÐÏîµÄÒÆÎ»
//     ¼´£ºÏòÉÏÒÆÎ»¡¢ÏòÏÂÒÆÎ»
//     ¾ßÌåµÄË¼Â·Îª£º´´½¨Ò»¸öListBox¶ÔÏó£¬²¢°ÑÒªÒÆÎ»µÄÏîÏÈÔÝ·ÅÔÚÕâ¸ö¶ÔÏóÖÐ¡£
//     Èç¹ûÊÇÏòÉÏÒÆÎ»£¬¾ÍÊÇ°Ñµ±Ç°Ñ¡¶¨ÏîµÄµÄÉÏÒ»ÏîµÄÖµ¸³¸øµ±Ç°Ñ¡¶¨µÄÏî£¬È»ºó
//     °Ñ¸Õ²ÅÐÂ¼ÓÈëµÄ¶ÔÏóµÄÖµ£¬ÔÙ¸½¸øµ±Ç°Ñ¡¶¨ÏîµÄÇ°Ò»Ïî¡£
//     ¾ßÌå´úÂëÎª£º
//      //¶¨ÒåÒ»¸ö±äÁ¿£¬×÷ÒÆÎ»ÓÃ
//      index = -1;
//      //½«µ±Ç°ÌõÄ¿µÄÎÄ±¾ÒÔ¼°Öµ¶¼±£´æµ½Ò»¸öÁÙÊ±±äÁ¿ÀïÃæ
//      ListItem lt=new ListItem (ListBox.SelectedItem.Text,ListBox.SelectedValue);
//      //±»Ñ¡ÖÐµÄÏîµÄÖµµÈÓÚÉÏÒ»Ìõ»òÏÂÒ»ÌõµÄÖµ
//      ListBox.Items[ListBox.SelectedIndex].Text=ListBox.Items[ListBox.SelectedIndex + index].Text;
//      //±»Ñ¡ÖÐµÄÏîµÄÖµµÈÓÚÉÏÒ»Ìõ»òÏÂÒ»ÌõµÄÖµ
//      ListBox.Items[ListBox.SelectedIndex].Value=ListBox.Items[ListBox.SelectedIndex + index].Value;
//      //°Ñ±»Ñ¡ÖÐÏîµÄÇ°Ò»Ìõ»òÏÂÒ»ÌõµÄÖµÓÃÁÙÊ±±äÁ¿ÖÐµÄÈ¡´ú
//      ListBox.Items[ListBox.SelectedIndex].Test=lt.Test;
//      //°Ñ±»Ñ¡ÖÐÏîµÄÇ°Ò»Ìõ»òÏÂÒ»ÌõµÄÖµÓÃÁÙÊ±±äÁ¿ÖÐµÄÈ¡´ú
//      ListBox.Items[ListBox.SelectedIndex].Value=lt.Value;
//      //°ÑÊó±êÖ¸Õë·Åµ½ÒÆ¶¯ºóµÄÄÇÏîÉÏ
//      ListBox.Items[ListBox.SelectedIndex].Value=lt.Value;

//9. ÒÆ¶¯Ö¸Õëµ½Ö¸¶¨Î»ÖÃ£º

//      (1).ÒÆÖÁÊ×Ìõ
//          //½«±»Ñ¡ÖÐÏîµÄË÷ÒýÉèÖÃÎª0¾ÍOKÁË
//          ListBox.SelectIndex=0;
//      (2).ÒÆÖÁÎ²Ìõ
//          //½«±»Ñ¡ÖÐÏîµÄË÷ÒýÉèÖÃÎªListBox.Items.Count-1¾ÍOKÁË
//          ListBox.SelectIndex=ListBox.Items.Count-1;
//      (3).ÉÏÒ»Ìõ
//          //ÓÃµ±Ç°±»Ñ¡ÖÐµÄË÷ÒýÈ¥¼õ 1
//          ListBox.SelectIndex=ListBox.SelectIndex - 1;
//      (4).ÏÂÒ»Ìõ
//          //ÓÃµ±Ç°±»Ñ¡ÖÐµÄË÷ÒýÈ¥¼Ó 1
//          ListBox.SelectIndex=ListBox.SelectIndex + 1;

//this.ListBox1.Items.Insertat(3,new   ListItem("²åÈëÔÚµÚ3ÐÐÖ®ºóÏî",""));  

//this.ListBox1.Items.Insertat(index,ListItem)

//ListBox1.Items.Insert(0,new   ListItem("text","value"));
#endregion
